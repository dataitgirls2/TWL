# 180914

## 오전 - 군집분석&시계열자료분석 (지현쌤)

### 군집분석

#### 고객 세분화 및 마케팅 전략 수립

### 군집분석 사례

#### 군집별로 따로 모델 수립

군집분석 자체가 목적이 될 수도, 모델링을 위한 수단이 될 수도 있음. 

### 군집분석이 필요한 이유

- 데이터를 속성이 비슷한 개체끼리 분류할 수 있음.
  - 관리의 편의성 및 효율성 증가
  - (eg) 게임 유저들의 일주일 동안 획득한 경험치 양과 플레이 시간으로 4개의 군집 설정
- 평균의 함정에 빠지지 않음
  - 평균의 함정: 집단의 평균이 집단에 속한 각 개체의 특성을 잘 반영해 주지 못하는 현상

### 군집분석이란?

#### 군집분석

군집분석: 유사성 정도에 따라 그룹화(군집 내 동질성, 군집 간 이질성)

#### 유사성 측도

유사성 측도: 유사성 정도를 나타내주는 도구

- 유클리디안 거리
- 맨하탄 거리

### 군집분석 방법

- 계층적 군집분석
- 비계층적 군집분석

### k-means

#### k-평균 알고리즘(k-means algorithm)

: 데이터를 k개의 그룹으로 군집

- k-means군집방법은 변수의 종류를 정해줘야 함 --> 도메인 지식
- k-means군집방법은 k개의 개수를 정해줘야 함 --> 최적의 k개수를 어떻게 구할까?

#### k-means알고리즘에서 최적의 k값 선택하기

- elbow method(팔꿈치 방법)
  - 군집 내 유사성을 오차제곱합(sse)으로 계산함
  - 오차제곱합이 작을수록 군집 내 유사성이 높다고 해석
- 값의 변화 비율이 급격히 작아지는 부분을 선택

### 계층적 군집분석

#### 계층적 군집분석(hierarchical clustering)

#### 상향식(Agglomerative)

상향식 계층적 군집분석은 클러스터 계층구조가 dendrogram(트리)로 표시됨.

수평선을 그려서 군집의 분리를 확인할 수 있음.

- 데이터가 커질수록 하향식을 사용했을 경우 시간이 오래걸리고 효율성이 떨어짐.

### 군집분석 단계

1. 변수 선택 - 군집화를 위한 속성 선별
2. 데이터 표준화
3. 이상치 처리
4. 군집 알고리즘 선택 & 거리의 계산
   - k-means  & elbow / menhatan
5. 군집의 개수 결정
6. 분석 결과의 시각화 및 해석

### 군집분석 후 데이터 분석 진행 방법

시군구에 따라 특성이 존재한다면, 전체 서울시에 대한 모델보다 각각의 군집에 대한 모델을 만들어서 합치는 것이 더 성능이 좋은 경향이 있음.

### 실습

#### 군집분석 모델 설정

1. 군집 별로 모델을 다르게 세우기
2. 군집 별로 자료를 요약한 후, factor(범주형) 변수로 넣어주기

#### 원본 데이터

**목적)** 주 별 총 매출액 구하기

- 각 지역의 주 별 매출액의 합을 구하는 것이 목표

**해결방법 1)** 기존 데이터로 모델링 한 후 y 예측

- Y: 매출, X: x1,x2,area —> 더미변수 등을 이용해 주차 별 데이터 요약

**해결방법 2)** 주차 별로 데이터 요약한 후 Y 예측

- 각각의 주차 별로 평균 등으로 데이터를 요약해준 후 Y를 예측함.

**해결방법 3)** 각각의 지역별로 나눈 후 매출액 예측하기

- area별로 데이터를 자른 후 a,b,c 각 지역에 대한 매출액을 예측하는 모델을 적합시킨 후, 전체 매출액을 계산함.

#### 지역별로 군집을 나눈 후 다시 고려 해보기

area를 기준으로 군집화

**해결방법 4)** 군집 별로 데이터를 요약한 후 매출액 예측

- 군집 별로 데이터를 요약 --> Y: 각 군집의 총 매출 합, x1,x2: 각 군집의 평균/최빈값/max 등
- 군집 별로 데이터를 요약하는 이유?
  - 전체 지역의 매출액을 구하려고 할 때, 서울/대전/부산 등으로 나누러 볼 수 있을 것. 하지만 서울 내 여러 구 들의 특성이 뚜렷한 경우, 그렇게 묶어버리면 각 구 별 특성이 사라져 버릴 수 있음.

**해결방법 5)** 군집 별로 데이터를 분리 & 요약한후 매출액 예측

- 군집 별로 데이터를 분리 & 요약 > 각 군집의 총 합을 따로 구하고 각각 모델을 적합, 각 군집에 대한 매출액을 예측한 후 전체 매출액을 계산함.

#### 군집분석에서의 주의점

Performance를 비교할 때 (RMSE)단위를 맞춘 후 구하기!

- 원하는 전체 데이터의 y와 x > A/B 군집으로 나눔. > 각 군집 별 RMSE를 구할 수 있음.
  - 여기에서 '전체의 RMSE값' 과 '각 군집 별 RMSE의 합' 을 비교하면 안됨!

## 시계열 자료분석

### 시계열 사례

- 시계열 자료: 일/월/분기/년간 등 시간과 관련된 자료
  - 경제 시계열: 국민 총생산액, 물가지수, 주가 등
  - 물리적 시계열: 일일 강수량, 지진 발생 수, 태양 흑점 수 등
  - 경영 시계열: 상품 판매량, 광고비 지출액 등
  - 인구 시계열: 총 인구, 농가 수, 인구증가율 등
  - 그 외: 품질, 공업/공학/제조, 범죄 등 사회변수 관련 시계열

### 시계열 분석이 필요한 이유

- 현재까지 수집된 자료들을 분석하여 미래에 대한 예측을 할 수 있음.
  - (eg) 향후 일주일 간 주가 예측, 다음 달 매출액 예측 ... 등
- 시계열 데이터의 특성을 파악할 수 있음.
  - 경향(trend), 계절성(seasonality), 주기(cycle), 불규칙성(irregular, random)

### 시계열 분석이란?

- 시계열 자료: 일/월/분기/년 등 시간과 관련된 자료
- 시계열 자료를 분석하기 위해 가장 먼저 해야 하는 것
  - 시계열 그림 그리기
  - 시계열 그림: 시간을 가로축으로 하고 시계열의 관측 값을 세로 축으로 하여 그린 것

### 시계열 자료의 요소

#### 추세변동(Trend)

시간이 경과함에 따라 관측값이 지속적으로 증가하거나 감소하는 추세를 갖는 변동

#### 계절변동(Seasonal)

시간이 경과함에 따라 관측값이 계절에 따른 변동을 갖는 경우(주기가 짧음)

- 순환변동(cycle): 흑점 수의 변화 같이 주기가 긴 경우의 변동

#### 불규칙 성분(Random)

시간에 따른 규칙적인 움직임과는 무관하게 랜덤한 원인에 의해 나타나는 변동 성분

### 시계열 모델

- 추세분석: 시간 t(설명변수)의 함수로 표현
- 분해법: 시계열 자료는 변동들의 혼합으로 이루어지는 것. 따라서 이 시계열 자료를 형성하고 있는 변동 요소를 찾아내고 시계열 자료를 그 요소들로 표현하여 예측
- 평활법: 체계적인 움직임을 찾아내기 위하여 과거자료의 불규칙한 변동을 제거
- ARIMA: 정상적 시계열에 대해 모형의 식별, 추정 등의 과정을 거쳐 예측. 비정상시계열은 정상화가 필요함

#### 추세분석

시간 t(설명변수)의 함수로 표현

#### 분해법

시계열을 여러가지 성분으로 분해한 후 성분들을 각각 추정하여 원래의 시계열을 해석하는 방법

- 체계적 성분
  - 추세성분
  - 계절성분
  - 순환성분
- 불규칙 성분

#### 평활법

과거와 현재의 값으로 미래의 값을 예측

- 이동 평균법: 과거 자료의 영향을 동일하게 고려
- 지수 평활법: 가까운 시점에 많은 가중치를 주고, 멀어질수록 낮은 가중치 부여
  - 예를들어 주가의 경우, 일주일 전의 값과 어제의 값에 대한 가중치를 다르게 주어야 더 정확할 것

#### ARIMA

- 과거의 관측값(AR)과 오차(MA)를 사용햇서 현재의 시계열 값을 설명하는 방법론
- 안정적인 시계열에섯 적용 가능

### 시계열 자료의 안정성

1. 시간의 추이와 관계없이 평균이 불변
2. 시간의 추이와 관계없이 분산이 불변
3. 두 시점 간의 공분산이 기준 시점과 무관

왜 시계열을 안정적으로 만들까?

- 너무 가변적인 경우, 추정해야 할 모수가 너무 많아 짐.
- 일반적인 시계열 모형의 경우, 안정적인 상황에서만 작동하기 때문에

#### 정상성(Stationarity)

- 시계열이 안정된 시계열인지 아닌지가 중요한 이유는?
  - 일반적으로 시계열 분석 방법들은 시계열이 안정적일거라고 가정하고 모델을 만듬.
- 만약 시계열이 안정적이지 않다면?(non- stationary)
  - 분산이 일정하지 않은 경우
    - 루트, 역수, 로그변환을 통해 안정화시킴
  - 평균이 일정하지 않은 경우(단, 분산은 일정)
    - 차분을 통해 안정화시킴
  - 차분: Z(t) - Z(t-1)

### AR process

#### AR(Auto Regressive)

- 현재 시계열 값이 과거 시계열 값들로 생성됨.
  - AR(1) process: 현재의 값이 **바로 전 시점의 값**들로 생성. (과거 시점들로 이루어짐)
  - AR(p) process: 현재의 값이 p시점 전까지의 값들로 생성.

### MA process

#### MA(Moving Average)

- 현재의 시계열 값이 현재와 과거의 오차항들의 결합으로 생성됨.
  - 랜덤하게 움직이기는 하지만, 어떤 평균값을 기준으로 랜덤함.
  - 특정 평균값은 따로 구해주는 값.
  - MA(1) process: 어떤 평균값을 중심으로 **현재의 오차**와, **바로 전 시점의 오차**로 Z가 표현됨.
  - MA(p) process: 현재의 값이 어떤 평균값을 중심으로 **현재 ~ p시점 전까지의 오차**로 표현됨.
- 안정적인 시계열인지? 등은 수식으로 증명 가능.

### ARIMA

#### ARIMA

AR process + I (Integrated) + MA process

### 차분(integrated)

#### 차분

- AR과 MA가 결합한 ARMA모형은 시계열 데이터 중 cycle성분, 불규칙성을 표현
- ARMA를 사용하더라도 시계열 자료에서 추세와 계절성이 남아있음
- 차분은 추세와 계절성 성분을 제외하는데 도움을 줌
- 따라서, 차분을 통해 전체 시계열 자료에서 추세와 계절성 성분을 제외하면 cycle과 불규칙성만 남게 됨.
- 차분: Z(t) - Z(t-1)

### ACF & PACF

- 자기상관함수(Auto Correlation Function)
- 부분자기상관함수(Partial Auto Correlation Function)

확률과정

| 확률과정  | ACF                                                          | PACF                                                         |
| --------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| AR(p)     | 지수적으로 감소하거나 소멸하는 싸인함수 형태                 | 시차 p이후에는 0으로의 절단 형태                             |
| MA(q)     | 시차 q이후에는 0으로의 절단 형태                             | 지수적으로 감소하거나 소멸하는 싸인함수 형태                 |
| ARMA(p,q) | 시차(p,q)이후에는 지수적으로 감소하거나 소멸하는 싸인함수 형태 | 시차(p-q)이후에는 지수적으로 감소하거나 소멸하는 싸인함수 형태 |

### ARIMA

#### ARIMA 분석 순서

1. 시계열 자료를 시각화해서 안정적 시계열인지를 확인
2. 시계열 자료를 안정적 시계열로 변환
3. ACF/PACF를 사용하여 최적화된 파라미터를 찾음
4. ARIMA 모형을 만듬
5. (필요한 경우) 미래 추이에 대해 예측

### 시계열 실습

#### 시계열 실습

### 시계열 데이터를 분석할 때의 주의점

시계열 분석은 보통 y의 값만을 가지고 분석함.

보통 회귀분석처럼 시계열이 아닌 것 처럼 모델을 만들고 예측을 하는 경우가 많음. 물론 시계열적인 특성이 보인다면 arima모델을 사용하기도 하지만, 일반 회귀분석의 모델링을 사용함.

#### 주의점

1. 데이터의 train/test셋을 잘 나누어야 함.

2. train

   - 예를 들어

     y: 피부염 환자 수, x들: 미세먼지, 습도, 온도 라고 했을 때, 환자 수가 과연 당일의 x들에 대한 영향을 받는 지, 혹은 전날, 일주일 전날의 영향을 받는 지 정확히 파악해야 함.

     산불의 경우에는 해당 날의 온도, 습도의 영향을 받겠지만, 피부염 환자의 수는 어제의 미세먼지나 대기 상황에 영향을 받을 것이라고 예상 가능함.

   - 내일의 피부염 환자 수를 알고 싶을 때, 우리는 내일의 정보들을 알 수 없음. 그래서 reg를 해주기도 함.

3. 자료의 통일성

   - 산불(y)에는 온도, 습도(x1,x2)의 영향을 받는다고 가정할 때, 그 날의 산불이 날지/안날지 는 그날의 습도와 온도에 영향을 더 받을 것.
   - 미래를 예측할 경우, 내일의 온도/습도를 미리 알 수가 없음. 데이터의 온도와 습도자료가 다른 문제가 발생.
     - 모델을 실제온도와 습도를 사용 / 예측은 예측온도와 습도를 사용 (X)
     - 모델에도 그 전날의 예측온도와 습도를 사용 / 예측또한 오늘의 예측온도와 습도를 사용해야 조금 더 정확한 예측이 가능할 것.